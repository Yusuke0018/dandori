<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ダンドリ - スマートなタスク管理</title>
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ダンドリ">
    
    <!-- Android Meta Tags -->
    <meta name="theme-color" content="#FFFFFF">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/views.css">
    <link rel="stylesheet" href="css/panel.css">
</head>
<body>
    <div id="app">
        <!-- 左トグルは廃止 -->
        
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">ダンドリ</h1>
                    <div class="progress-ring-container">
                        <svg class="progress-ring" width="36" height="36">
                            <defs>
                                <linearGradient id="ringGrad" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#FF8A3D"/>
                                    <stop offset="50%" stop-color="#E84393"/>
                                    <stop offset="100%" stop-color="#26C6DA"/>
                                </linearGradient>
                                <filter id="ringShadow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.2"/>
                                </filter>
                            </defs>
                            <circle class="progress-ring-bg" cx="18" cy="18" r="15" stroke-width="3" fill="none"/>
                            <circle class="progress-ring-fill" cx="18" cy="18" r="15" stroke-width="3" fill="none"
                                    stroke="url(#ringGrad)" filter="url(#ringShadow)"
                                    stroke-dasharray="94.2" stroke-dashoffset="94.2"/>
                        </svg>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                
            </div>
            <!-- Top Navigation Tabs -->
            <nav class="view-tabs" role="tablist" aria-label="ビュー切替">
                <button class="tab-btn" data-view="timeline" aria-selected="true">今日</button>
                <button class="tab-btn" data-view="calendar">カレンダー</button>
                <button class="tab-btn" data-view="board">いつかやる</button>
                <button class="tab-btn" data-view="projects">プロジェクト</button>
                <button class="tab-btn" data-view="completed">履歴</button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main class="app-main">
            

            <!-- Timeline View -->
            <div id="timeline-view" class="view-container">
                <div class="date-header">
                    <button class="date-nav prev" aria-label="前日">‹</button>
                    <h2 class="current-date">12月31日（火）</h2>
                    <button class="date-nav next" aria-label="翌日">›</button>
                </div>
                
                <!-- Day Tasks (Time Unspecified) -->
                <div class="day-tasks">
                    <h3 class="section-title">この日のタスク</h3>
                    <div class="day-tasks-list">
                        <!-- Day tasks will be rendered here -->
                    </div>
                </div>
                
                <!-- Timeline Grid -->
                <div class="timeline-container">
                    <div class="time-labels">
                        <!-- Time labels 0:00 - 23:00 -->
                    </div>
                    <div class="timeline-grid">
                        <!-- Current time indicator -->
                        <div class="current-time-line"></div>
                        <!-- Timed tasks will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Calendar Full View -->
            <div id="calendar-view" class="view-container">
                <div class="date-header">
                    <button class="cal-nav prev" aria-label="前月">‹</button>
                    <h2 class="calendar-month-label">2024年12月</h2>
                    <button class="cal-nav next" aria-label="翌月">›</button>
                </div>
                <div class="full-calendar">
                    <div class="calendar-grid">
                        <!-- Full calendar days will be rendered here -->
                    </div>
                    <div class="calendar-tasks">
                        <!-- Selected day's tasks -->
                    </div>
                </div>
            </div>

            <!-- Board View (Someday) -->
            <div id="board-view" class="view-container">
                <h2 class="view-title">いつかやるタスク</h2>
                <div class="board-grid">
                    <!-- Someday tasks will be rendered here -->
                </div>
            </div>

            <!-- Projects View -->
            <div id="projects-view" class="view-container">
                <h2 class="view-title">プロジェクト</h2>
                <div class="projects-list">
                    <!-- Project cards will be rendered here -->
                </div>
            </div>

            <!-- Completed View -->
            <div id="completed-view" class="view-container">
                <h2 class="view-title">完了履歴</h2>
                <div class="completed-controls">
                    <input type="text" id="completed-search" placeholder="キーワードで絞り込み" aria-label="完了検索">
                    <div style="flex:1"></div>
                    <button class="btn" id="btn-completed-select-all" aria-label="完了一覧を全選択">全選択</button>
                    <button class="btn btn-danger" id="btn-completed-revert" aria-label="選択を未達成に戻す">未達成に戻す</button>
                </div>
                <div class="completed-list">
                    <!-- Completed tasks will be rendered here -->
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-container">
                <h2 class="view-title">設定</h2>
                <div class="settings-section">
                    <label class="settings-row">
                        <span>未完了の時間指定タスクを翌日に繰り越す</span>
                        <input type="checkbox" id="setting-carryover">
                    </label>
                    <label class="settings-row">
                        <span>起動時の表示</span>
                        <select id="setting-default-view">
                            <option value="timeline">今日（タイムライン）</option>
                            <option value="board">いつかやる</option>
                            <option value="projects">プロジェクト</option>
                            <option value="completed">完了履歴</option>
                        </select>
                    </label>
                </div>
                <div class="settings-section">
                    <button class="btn" id="btn-export">データをエクスポート</button>
                    <input type="file" id="input-import" accept="application/json" hidden>
                    <button class="btn" id="btn-import">データをインポート</button>
                </div>
            </div>
        </main>

        <!-- Floating Add Button -->
        <button class="btn-add" aria-label="タスク追加">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>

        <!-- Task Editor Modal -->
        <div id="task-modal" class="modal" hidden>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">タスクを追加</h3>
                    <button class="modal-close" aria-label="閉じる">×</button>
                </div>
                <form id="task-form" class="task-form">
                    <div class="form-group">
                        <label for="task-title">タスク名</label>
                        <input type="text" id="task-title" required placeholder="何をしますか？">
                    </div>
                    
                    <div class="form-group">
                        <label>タイプ</label>
                        <div class="task-type-selector">
                            <button type="button" class="type-btn" data-type="someday">いつかやる</button>
                            <button type="button" class="type-btn active" data-type="day">特定の日</button>
                            <button type="button" class="type-btn" data-type="timed">時間指定</button>
                        </div>
                    </div>
                    
                    <div class="form-group date-group">
                        <label for="task-date">日付</label>
                        <input type="date" id="task-date">
                    </div>
                    
                    <div class="form-group time-group" hidden>
                        <label>時間</label>
                        <div class="time-inputs">
                            <input type="time" id="task-start" placeholder="開始">
                            <span>〜</span>
                            <input type="time" id="task-end" placeholder="終了">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="task-project">プロジェクト</label>
                        <select id="task-project">
                            <option value="">なし</option>
                            <!-- Projects will be populated here -->
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-cancel">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Project Editor Modal -->
        <div id="project-modal" class="modal" hidden>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="project-modal-title">プロジェクトを追加</h3>
                    <button class="project-modal-close" aria-label="閉じる">×</button>
                </div>
                <form id="project-form" class="task-form">
                    <div class="form-group">
                        <label for="project-name">プロジェクト名</label>
                        <input type="text" id="project-name" required placeholder="例）健康、仕事、学習">
                    </div>
                    <div class="form-group">
                        <label for="project-color">色</label>
                        <select id="project-color">
                            <option value="blue">青</option>
                            <option value="green">緑</option>
                            <option value="orange">橙</option>
                            <option value="red">赤</option>
                            <option value="purple">紫</option>
                            <option value="teal">青緑</option>
                            <option value="pink">桃</option>
                            <option value="gray">灰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="project-deadline">期限（任意）</label>
                        <input type="date" id="project-deadline">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-danger btn-project-delete" hidden>削除</button>
                        <div style="flex:1"></div>
                        <button type="button" class="btn btn-cancel project-cancel">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/main.js" type="module"></script>
    <script>
      // Service Worker登録 + 強制更新 + 旧キャッシュ削除（次回ロード時に確実反映）
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          const v = 'v10'; // bump to bust registration cache
          try {
            const reg = await navigator.serviceWorker.register(`./sw.js?${v}`, { scope: './' });
            // 強制更新を試行
            reg.update && reg.update();
          } catch (_) {}

          // 旧キャッシュの削除（現行名以外）
          const CURRENT = 'dandori-cache-v12';
          if ('caches' in window) {
            try {
              const keys = await caches.keys();
              await Promise.all(keys.filter(k => k.startsWith('dandori-cache-') && k !== CURRENT).map(k => caches.delete(k)));
            } catch (_) {}
          }

          // SWが切り替わったら一度だけリロード
          let reloaded = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (reloaded) return; reloaded = true; location.reload();
          });
        });
      }
    </script>
</body>
</html>
